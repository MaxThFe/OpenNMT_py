

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="EN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="EN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How do I use my v2 models in v3 ? &mdash; OpenNMT-py  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Translation WMT17 en-de" href="examples/wmt17/Translation.html" />
    <link rel="prev" title="References" href="ref.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> OpenNMT-py
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="main.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html">Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="ref.html">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Frequently Asked Questions</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">How do I use my v2 models in v3 ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="#how-do-i-train-the-transformer-model">How do I train the Transformer model?</a></li>
<li class="toctree-l1"><a class="reference internal" href="#performance-tips">Performance tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="#position-encoding-absolute-vs-relative-vs-rotary-embeddings-vs-alibi">Position encoding: Absolute vs Relative vs Rotary Embeddings vs Alibi</a></li>
<li class="toctree-l1"><a class="reference internal" href="#do-you-support-multi-gpu">Do you support multi-gpu?</a></li>
<li class="toctree-l1"><a class="reference internal" href="#how-do-i-use-pretrained-embeddings-e-g-glove">How do I use Pretrained embeddings (e.g. GloVe)?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#how-can-i-ensemble-models-at-inference">How can I ensemble Models at inference?</a></li>
<li class="toctree-l1"><a class="reference internal" href="#how-can-i-weight-different-corpora-at-training">How can I weight different corpora at training?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#what-special-tokens-does-opennmt-py-use">What special tokens does OpenNMT-py use?</a></li>
<li class="toctree-l1"><a class="reference internal" href="#how-can-i-apply-on-the-fly-tokenization-and-subword-regularization-when-training">How can I apply on-the-fly tokenization and subword regularization when training?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#what-are-the-readily-available-on-the-fly-data-transforms">What are the readily available on-the-fly data transforms?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#general-purpose">General purpose</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#filter-examples-by-length">Filter examples by length</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-custom-prefix-to-examples">Add custom prefix to examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-custom-suffix-to-examples">Add custom suffix to examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-examples-to-uppercase">Convert examples to uppercase</a></li>
<li class="toctree-l3"><a class="reference internal" href="#normalize-punctuation">Normalize punctuation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#clean-dataset">Clean dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#context-doc-aware-transform">Context / Doc aware transform</a></li>
<li class="toctree-l3"><a class="reference internal" href="#augment-source-segments-with-fuzzy-matches-for-neural-fuzzy-repair">Augment source segments with fuzzy matches for Neural Fuzzy Repair</a></li>
<li class="toctree-l3"><a class="reference internal" href="#augment-source-and-target-segments-with-inline-tags">Augment source and target segments with inline tags</a></li>
<li class="toctree-l3"><a class="reference internal" href="#make-the-model-learn-to-use-terminology">Make the model learn to use terminology</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tokenization">Tokenization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#opennmt-tokenizer">OpenNMT Tokenizer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sentencepiece">SentencePiece</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bpe-subword-nmt">BPE subword-nmt</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#bart-style-noise">BART-style noise</a></li>
<li class="toctree-l2"><a class="reference internal" href="#switchout-and-sampling">SwitchOut and sampling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#switchout">SwitchOut</a></li>
<li class="toctree-l3"><a class="reference internal" href="#drop-some-tokens">Drop some tokens</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mask-some-tokens">Mask some tokens</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#how-can-i-create-custom-on-the-fly-data-transforms">How can I create custom on-the-fly data transforms?</a></li>
<li class="toctree-l1"><a class="reference internal" href="#how-to-use-lora-and-8bit-loading-to-finetune-a-big-model">How to use LoRa and 8bit loading to finetune a big model ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="#how-to-use-gradient-checkpointing-when-dealing-with-a-big-model">How to use gradient checkpointing when dealing with a big model ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="#can-i-get-word-alignments-while-translating">Can I get word alignments while translating?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#raw-alignments-from-averaging-transformer-attention-heads">Raw alignments from averaging Transformer attention heads</a></li>
<li class="toctree-l2"><a class="reference internal" href="#supervised-learning-on-a-specific-head">Supervised learning on a specific head</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#how-can-i-update-a-checkpoint-s-vocabulary">How can I update a checkpoint’s vocabulary?</a></li>
<li class="toctree-l1"><a class="reference internal" href="#how-can-i-use-source-word-features">How can I use source word features?</a></li>
<li class="toctree-l1"><a class="reference internal" href="#how-can-i-set-up-a-translation-server">How can I set up a translation server ?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#i-how-it-works">I. How it works?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configuration">Configuration:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ii-how-to-start-the-server-without-docker">II. How to start the server without Docker ?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#get-the-code">0. Get the code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-flask">1. Install <code class="docutils literal notranslate"><span class="pre">flask</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#put-some-models">2. Put some models</a></li>
<li class="toctree-l3"><a class="reference internal" href="#start-the-server">3. Start the server</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#iii-how-to-start-the-server-with-docker">III. How to start the server with Docker ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#iv-how-to-use-the-api">IV. How to use the API ?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#set-the-hostname">0. Set the hostname</a></li>
<li class="toctree-l3"><a class="reference internal" href="#list-models">1. List models</a></li>
<li class="toctree-l3"><a class="reference internal" href="#translate">2. Translate</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="examples/wmt17/Translation.html">Translation WMT17 en-de</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples/wiki_103/LanguageModelGeneration.html">Language Model Wiki-103</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples/summary/Summarization.html">Summarization CNN/DM</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples/ggnn/GGNN.html">Gated Graph Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples/replicate_vicuna/ReplicateVicuna.html">Supervised Finetuning of llama 7B to replicate Vicuna</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Scripts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="options/build_vocab.html">Build Vocab</a></li>
<li class="toctree-l1"><a class="reference internal" href="options/train.html">Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="options/translate.html">Translate</a></li>
<li class="toctree-l1"><a class="reference internal" href="options/server.html">Server</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="onmt.html">Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="onmt.modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="onmt.translation.html">Translation</a></li>
<li class="toctree-l1"><a class="reference internal" href="onmt.translate.translation_server.html">Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="onmt.inputters.html">Data Loaders</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Legacy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="legacy/FAQ.html">FAQ (Legacy version)</a></li>
<li class="toctree-l1"><a class="reference internal" href="legacy/im2text.html">Image to Text</a></li>
<li class="toctree-l1"><a class="reference internal" href="legacy/speech2text.html">Speech to Text</a></li>
<li class="toctree-l1"><a class="reference internal" href="legacy/vid2text.html">Video to Text</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">OpenNMT-py</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>How do I use my v2 models in v3 ?</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/FAQ.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p>All the example YAML configurations are partial. To get an overview of what this YAML configuration is you can start by reading the <a class="reference internal" href="quickstart.html"><span class="doc">Quickstart</span></a> section.</p>
<p>Also you can have a look at this: <a class="reference external" href="https://github.com/ymoslem/OpenNMT-Tutorial">Tutorial</a></p>
<section id="how-do-i-use-my-v2-models-in-v3">
<h1>How do I use my v2 models in v3 ?<a class="headerlink" href="#how-do-i-use-my-v2-models-in-v3" title="Permalink to this heading">¶</a></h1>
<p>As a reminder, OpenNMT-py v2.x used to rely on Torchtext 0.5</p>
<p>This torchtext version used “Fields”, “RawFields”, “MultiFields” which were deprecated in torchtext versions &gt; 0.5. In order to convert old models we have to mimic those old Class and as a result you need to install a newer version of torchtext.</p>
<p>If you use pytorch 1.12.1 then install torchtext 0.13</p>
<p>If you use pytorch 1.13.0 then install torchtext 0.14</p>
<p>After the conversion you can eliminate completely torchtext.</p>
<p>Conversion is perfomed using the following script:</p>
<p>python tools/convertv2_v3.py -v2model myoldmodel.pt -v3model newmodel.pt</p>
<p>The new checkpoint will no longer have a “fields” key, replaced by “vocab”
Some model options are modified as follow:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rnn_size</span></code> is now <code class="docutils literal notranslate"><span class="pre">hidden_size</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">enc_rnn_size</span></code> is now <code class="docutils literal notranslate"><span class="pre">enc_hid_size</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dec_rnn_size</span></code> is now <code class="docutils literal notranslate"><span class="pre">dec_hid_size</span></code></p></li>
</ul>
<p>A new key <code class="docutils literal notranslate"><span class="pre">add_qkvbias</span></code> is set to <code class="docutils literal notranslate"><span class="pre">true</span></code> for old models.</p>
<p>New models will be trained by default with <code class="docutils literal notranslate"><span class="pre">false</span></code></p>
<p>Special note for GPT2 type Language Model trained with v2</p>
<p>The special tokens of LM in v2 where not in line with NMT type models.
Only 3 special tokens (<code class="docutils literal notranslate"><span class="pre">&lt;unk&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;blank&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;/s&gt;</span></code>) were in the the vocab.
For v3, we aligned LM and NMT models.
You need to update the vocab by training from v2 converted to v3 checkpoint, with the update_vocab flag.
It will make the vocab consistent with v3 structure.</p>
</section>
<section id="how-do-i-train-the-transformer-model">
<h1>How do I train the Transformer model?<a class="headerlink" href="#how-do-i-train-the-transformer-model" title="Permalink to this heading">¶</a></h1>
<p>The transformer model is very sensitive to hyperparameters. To run it
effectively you need to set different options that mimic the <a class="reference external" href="https://arxiv.org/abs/1706.03762">Google</a> setup. We have confirmed the following configuration can replicate their WMT results.</p>
<p>Please have a look at the Example of WMT17 EN-DE.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">&lt;data configuration&gt;</span>
<span class="nn">...</span>

<span class="c1"># General opts</span>
<span class="nt">save_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mybasemodel</span>
<span class="nt">save_checkpoint_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="nt">valid_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="nt">train_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200000</span>

<span class="c1"># Batching</span>
<span class="nt">bucket_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">262144</span>
<span class="nt">world_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="nt">gpu_ranks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">]</span>
<span class="nt">num_workers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="nt">batch_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tokens&quot;</span>
<span class="nt">batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4096</span>
<span class="nt">valid_batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2048</span>
<span class="nt">accum_count</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">4</span><span class="p p-Indicator">]</span>
<span class="nt">accum_steps</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">]</span>

<span class="c1"># Optimization</span>
<span class="nt">model_dtype</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fp16&quot;</span>
<span class="nt">optim</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;adam&quot;</span>
<span class="nt">learning_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="nt">warmup_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
<span class="nt">decay_method</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;noam&quot;</span>
<span class="nt">adam_beta2</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.998</span>
<span class="nt">max_grad_norm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nt">label_smoothing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span>
<span class="nt">param_init</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nt">param_init_glorot</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">normalization</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tokens&quot;</span>

<span class="c1"># Model</span>
<span class="nt">encoder_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">transformer</span>
<span class="nt">decoder_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">transformer</span>
<span class="nt">position_encoding</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">enc_layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6</span>
<span class="nt">dec_layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6</span>
<span class="nt">heads</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="nt">hidden_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">512</span>
<span class="nt">word_vec_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">512</span>
<span class="nt">transformer_ff</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2048</span>
<span class="nt">dropout_steps</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">]</span>
<span class="nt">dropout</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.1</span><span class="p p-Indicator">]</span>
<span class="nt">attention_dropout</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.1</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>Here are what the most important parameters mean:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">param_init_glorot</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">param_init</span> <span class="pre">0</span></code>: correct initialization of parameters;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">position_encoding</span></code>: add sinusoidal position encoding to each embedding;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">optim</span> <span class="pre">adam</span></code>, <code class="docutils literal notranslate"><span class="pre">decay_method</span> <span class="pre">noam</span></code>, <code class="docutils literal notranslate"><span class="pre">warmup_steps</span> <span class="pre">8000</span></code>: use special learning rate;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">batch_type</span> <span class="pre">tokens</span></code>, <code class="docutils literal notranslate"><span class="pre">normalization</span> <span class="pre">tokens</span></code>: batch and normalize based on number of tokens and not sentences;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">accum_count</span> <span class="pre">4</span></code>: compute gradients based on four batches;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label_smoothing</span> <span class="pre">0.1</span></code>: use label smoothing loss.</p></li>
</ul>
</section>
<section id="performance-tips">
<h1>Performance tips<a class="headerlink" href="#performance-tips" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>use <code class="docutils literal notranslate"><span class="pre">fp16</span></code></p></li>
<li><p>use <code class="docutils literal notranslate"><span class="pre">batch_size_multiple</span></code> 8</p></li>
<li><p>use <code class="docutils literal notranslate"><span class="pre">vocab_size_multiple</span></code> 8</p></li>
<li><p>Depending on the number of GPU use num_workers 4 (for 1 GPU) or 2 (for multiple GPU)</p></li>
<li><p>To avoid averaging checkpoints you can use the “during training” average decay system.</p></li>
<li><p>If you train a transformer we support <code class="docutils literal notranslate"><span class="pre">max_relative_positions</span></code> (use 20) instead of position_encoding.</p></li>
<li><p>for very fast inference convert your model to CTranslate2 format.</p></li>
</ul>
</section>
<section id="position-encoding-absolute-vs-relative-vs-rotary-embeddings-vs-alibi">
<h1>Position encoding: Absolute vs Relative vs Rotary Embeddings vs Alibi<a class="headerlink" href="#position-encoding-absolute-vs-relative-vs-rotary-embeddings-vs-alibi" title="Permalink to this heading">¶</a></h1>
<p>The basic feature is absolute position encoding stemming from the original Transformer Paper.
However, even with this, we can use SinusoidalInterleaved (default OpenNMT-py) or SinusoidalConcat (default Fairseq imported models)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">position_encoding:</span> <span class="pre">true</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">position_encoding_type:</span> <span class="pre">'SinusoidalInterleaved'</span></code>
Do not forget to set also <code class="docutils literal notranslate"><span class="pre">param_init_glorot:</span> <span class="pre">true</span></code></p></li>
</ul>
<p>If you prefer to use relative position encoding, we support 3 modes:</p>
<ul class="simple">
<li><p>“Shaw”: https://arxiv.org/abs/1803.02155 - you need to set <code class="docutils literal notranslate"><span class="pre">max_relative_positions:</span> <span class="pre">N</span></code> where N &gt; 1 (use 16, 20, 32) see paper.</p></li>
<li><p>“Rope” Rotary Embeddings: https://arxiv.org/abs/2104.09864 - you need to set <code class="docutils literal notranslate"><span class="pre">max_relative_positions:</span> <span class="pre">-1</span></code></p></li>
<li><p>“Alibi” (used by MPT-7B for example) https://arxiv.org/abs/2108.12409 - you need to set <code class="docutils literal notranslate"><span class="pre">max_relative_positions:</span> <span class="pre">-2</span></code></p></li>
</ul>
<p>In both cases, it is necessary to set <code class="docutils literal notranslate"><span class="pre">position_encoding:</span> <span class="pre">false</span></code></p>
<p>In a nutshell, at the time if this writing (v3.1) absolute position encoding is managed in the Embeddings module, whereas
the relative position encoding is managed directly in the multi-head self-attention module.</p>
</section>
<section id="do-you-support-multi-gpu">
<h1>Do you support multi-gpu?<a class="headerlink" href="#do-you-support-multi-gpu" title="Permalink to this heading">¶</a></h1>
<p>First you need to make sure you <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">CUDA_VISIBLE_DEVICES=0,1,2,3</span></code>.</p>
<p>If you want to use GPU id 1 and 3 of your OS, you will need to <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">CUDA_VISIBLE_DEVICES=1,3</span></code></p>
<p>Both <code class="docutils literal notranslate"><span class="pre">-world_size</span></code> and <code class="docutils literal notranslate"><span class="pre">-gpu_ranks</span></code> need to be set. E.g. <code class="docutils literal notranslate"><span class="pre">-world_size</span> <span class="pre">4</span> <span class="pre">-gpu_ranks</span> <span class="pre">0</span> <span class="pre">1</span> <span class="pre">2</span> <span class="pre">3</span></code> will use 4 GPU on this node only.</p>
<p><strong>Warning - Deprecated</strong></p>
<p>Multi-node distributed training has not been properly re-implemented since OpenNMT-py 2.0.</p>
<p>If you want to use 2 nodes with 2 GPU each, you need to set <code class="docutils literal notranslate"><span class="pre">-master_ip</span></code> and <code class="docutils literal notranslate"><span class="pre">-master_port</span></code>, and</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-world_size</span> <span class="pre">4</span> <span class="pre">-gpu_ranks</span> <span class="pre">0</span> <span class="pre">1</span></code>: on the first node</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-world_size</span> <span class="pre">4</span> <span class="pre">-gpu_ranks</span> <span class="pre">2</span> <span class="pre">3</span></code>: on the second node</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-accum_count</span> <span class="pre">2</span></code>: This will accumulate over 2 batches before updating parameters.</p></li>
</ul>
<p>If you use a regular network card (1 Gbps) then we suggest to use a higher <code class="docutils literal notranslate"><span class="pre">-accum_count</span></code> to minimize the inter-node communication.</p>
<p><strong>Note:</strong></p>
<p>In the legacy version, when training on several GPUs, you couldn’t have them in ‘Exclusive’ compute mode (<code class="docutils literal notranslate"><span class="pre">nvidia-smi</span> <span class="pre">-c</span> <span class="pre">3</span></code>).</p>
<p>The multi-gpu setup relied on a Producer/Consumer setup. This setup means there will be <code class="docutils literal notranslate"><span class="pre">2&lt;n_gpu&gt;</span> <span class="pre">+</span> <span class="pre">1</span></code> processes spawned, with 2 processes per GPU, one for model training and one (Consumer) that hosts a <code class="docutils literal notranslate"><span class="pre">Queue</span></code> of batches that will be processed next. The additional process is the Producer, creating batches and sending them to the Consumers. This setup is beneficial for both wall time and memory, since it loads data shards ‘in advance’, and does not require to load it for each GPU process.</p>
<p>The new codebase allows GPUs to be in exclusive mode, because batches are moved to the device later in the process. Hence, there is no ‘producer’ process on each GPU.</p>
</section>
<section id="how-do-i-use-pretrained-embeddings-e-g-glove">
<h1>How do I use Pretrained embeddings (e.g. GloVe)?<a class="headerlink" href="#how-do-i-use-pretrained-embeddings-e-g-glove" title="Permalink to this heading">¶</a></h1>
<p>This is handled in the initial steps of the <code class="docutils literal notranslate"><span class="pre">onmt_train</span></code> execution.</p>
<p>Pretrained embeddings can be configured in the main YAML configuration file.</p>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this heading">¶</a></h2>
<ol class="simple">
<li><p>Get GloVe files:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span><span class="s2">&quot;glove_dir&quot;</span>
wget<span class="w"> </span>http://nlp.stanford.edu/data/glove.6B.zip
unzip<span class="w"> </span>glove.6B.zip<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;glove_dir&quot;</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Adapt the configuration:</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># &lt;your_config&gt;.yaml</span>

<span class="l l-Scalar l-Scalar-Plain">&lt;Your data config...&gt;</span>

<span class="nn">...</span>

<span class="c1"># this means embeddings will be used for both encoder and decoder sides</span>
<span class="nt">both_embeddings</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">glove_dir/glove.6B.100d.txt</span>
<span class="c1"># to set src and tgt embeddings separately:</span>
<span class="c1"># src_embeddings: ...</span>
<span class="c1"># tgt_embeddings: ...</span>

<span class="c1"># supported types: GloVe, word2vec</span>
<span class="nt">embeddings_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;GloVe&quot;</span>

<span class="c1"># word_vec_size need to match with the pretrained embeddings dimensions</span>
<span class="nt">word_vec_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Train:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>onmt_train<span class="w"> </span>-config<span class="w"> </span>&lt;your_config&gt;.yaml
</pre></div>
</div>
<p>Notes:</p>
<ul class="simple">
<li><p>the matched embeddings will be saved at <code class="docutils literal notranslate"><span class="pre">&lt;save_data&gt;.enc_embeddings.pt</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;save_data&gt;.dec_embeddings.pt</span></code>;</p></li>
<li><p>additional flags <code class="docutils literal notranslate"><span class="pre">freeze_word_vecs_enc</span></code> and <code class="docutils literal notranslate"><span class="pre">freeze_word_vecs_dec</span></code> are available to freeze the embeddings.</p></li>
</ul>
</section>
</section>
<section id="how-can-i-ensemble-models-at-inference">
<h1>How can I ensemble Models at inference?<a class="headerlink" href="#how-can-i-ensemble-models-at-inference" title="Permalink to this heading">¶</a></h1>
<p>You can specify several models in the <code class="docutils literal notranslate"><span class="pre">onmt_translate</span></code> command line: <code class="docutils literal notranslate"><span class="pre">-model</span> <span class="pre">model1_seed1</span> <span class="pre">model2_seed2</span></code>
Bear in mind that your models must share the same target vocabulary.</p>
</section>
<section id="how-can-i-weight-different-corpora-at-training">
<h1>How can I weight different corpora at training?<a class="headerlink" href="#how-can-i-weight-different-corpora-at-training" title="Permalink to this heading">¶</a></h1>
<p>This is naturally embedded in the data configuration format introduced in OpenNMT-py 2.0. Each entry of the <code class="docutils literal notranslate"><span class="pre">data</span></code> configuration will have its own <em>weight</em>. When building batches, we’ll sequentially take <em>weight</em> example from each corpus.</p>
<p><strong>Note</strong>: don’t worry about batch homogeneity/heterogeneity, the bucketing mechanism is here for that reason. Instead of building batches one at a time, we will load <code class="docutils literal notranslate"><span class="pre">bucket_size</span></code> examples, sort them by length, build batches and then yield them in a random order.</p>
<section id="id1">
<h2>Example<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h2>
<p>In the following example, we will sequentially sample 7 examples from <em>corpus_1</em>, and 3 examples from <em>corpus_2</em>, and so on:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># &lt;your_config&gt;.yaml</span>

<span class="nn">...</span>

<span class="c1"># Corpus opts:</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">    </span><span class="nt">corpus_1</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path_src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/src-train1.txt</span>
<span class="w">        </span><span class="nt">path_tgt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/tgt-train1.txt</span>
<span class="w">        </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7</span>
<span class="w">    </span><span class="nt">corpus_2</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path_src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/src-train1.txt</span>
<span class="w">        </span><span class="nt">path_tgt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/tgt-train1.txt</span>
<span class="w">        </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">    </span><span class="nt">valid</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path_src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/src-val.txt</span>
<span class="w">        </span><span class="nt">path_tgt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/tgt-val.txt</span>
<span class="nn">...</span>
</pre></div>
</div>
</section>
</section>
<section id="what-special-tokens-does-opennmt-py-use">
<h1>What special tokens does OpenNMT-py use?<a class="headerlink" href="#what-special-tokens-does-opennmt-py-use" title="Permalink to this heading">¶</a></h1>
<p>In the v2, special tokens were different for SEQ2SEQ and LM:
LM was BOS, PAD, EOS with IDs (0, 1, 2) and the first vocab token started at id=3
SEQ2SEQ was UNK, PAD, BOS, EOS with IDs (0, 1, 2, 3) and first vocab token started at id=4</p>
<p>In v3 we changed this behavior to align things:
group.add(
“–default_specials”,
“-default_specilas”,
nargs=”+”,
type=str,
default=[
DefaultTokens.UNK,
DefaultTokens.PAD,
DefaultTokens.BOS,
DefaultTokens.EOS,
])</p>
<p>When we train a SEQ2SEQ model we use:
SRC: srctok1 srctok2 srctok3 …. srctokn
TGT: BOS tgttok1 tgttok2 ….. tgttokm EOS
But when training a LM
SRC: BOS srctok1 srctok2 srctok3 …. srctokn
TGT: srctok1 srctok2 srctok3 …. srctokn EOS</p>
<p>Having said that, sometimes we need to finetune models (eg: NLLB-200, Llama, …) with existing vocab
and special tokens are not the same.</p>
<p>ex with NLLB-200
BOS id=0
PAD id=1
EOS id=2
UNK id=3
And the decoder start token is EOS (</s>) which means in fact that the BOS is never used.
At training, TGT needs to start with EOS instead of BOS in the default OpenNMT-py config.</p>
<p>Example of Llama
UNK id=0
BOS id=1
EOS id=2
There was no PAD but to avoid conflicts we forced PAD id=3 (which was token ‘&lt;0x00&gt;’ in the original llama tokenizer)</p>
</section>
<section id="how-can-i-apply-on-the-fly-tokenization-and-subword-regularization-when-training">
<h1>How can I apply on-the-fly tokenization and subword regularization when training?<a class="headerlink" href="#how-can-i-apply-on-the-fly-tokenization-and-subword-regularization-when-training" title="Permalink to this heading">¶</a></h1>
<p>This is naturally embedded in the data configuration format introduced in OpenNMT-py 2.0. Each entry of the <code class="docutils literal notranslate"><span class="pre">data</span></code> configuration will have its own <code class="docutils literal notranslate"><span class="pre">transforms</span></code>. <code class="docutils literal notranslate"><span class="pre">transforms</span></code> basically is a <code class="docutils literal notranslate"><span class="pre">list</span></code> of functions that will be applied sequentially to the examples when read from file.</p>
<section id="id2">
<h2>Example<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h2>
<p>This example applies sentencepiece tokenization with <code class="docutils literal notranslate"><span class="pre">pyonmttok</span></code>, with <code class="docutils literal notranslate"><span class="pre">nbest=20</span></code> and <code class="docutils literal notranslate"><span class="pre">alpha=0.1</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># &lt;your_config&gt;.yaml</span>

<span class="nn">...</span>

<span class="c1"># Tokenization options</span>
<span class="nt">src_subword_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sentencepiece</span>
<span class="nt">src_subword_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examples/subword.spm.model</span>
<span class="nt">tgt_subword_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sentencepiece</span>
<span class="nt">tgt_subword_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examples/subword.spm.model</span>

<span class="c1"># Number of candidates for SentencePiece sampling</span>
<span class="nt">subword_nbest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
<span class="c1"># Smoothing parameter for SentencePiece sampling</span>
<span class="nt">subword_alpha</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span>
<span class="c1"># Specific arguments for pyonmttok</span>
<span class="nt">src_onmttok_kwargs</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{&#39;mode&#39;:</span><span class="nv"> </span><span class="s">&#39;none&#39;,</span><span class="nv"> </span><span class="s">&#39;spacer_annotate&#39;:</span><span class="nv"> </span><span class="s">True}&quot;</span>
<span class="nt">tgt_onmttok_kwargs</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{&#39;mode&#39;:</span><span class="nv"> </span><span class="s">&#39;none&#39;,</span><span class="nv"> </span><span class="s">&#39;spacer_annotate&#39;:</span><span class="nv"> </span><span class="s">True}&quot;</span>

<span class="c1"># Corpus opts:</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">    </span><span class="nt">corpus_1</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path_src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/src-train1.txt</span>
<span class="w">        </span><span class="nt">path_tgt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/tgt-train1.txt</span>
<span class="w">        </span><span class="nt">transforms</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">onmt_tokenize</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">valid</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path_src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/src-val.txt</span>
<span class="w">        </span><span class="nt">path_tgt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/tgt-val.txt</span>
<span class="w">        </span><span class="nt">transforms</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">onmt_tokenize</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Other tokenization methods and transforms are readily available. See the dedicated docs for more details.</p>
</section>
</section>
<section id="what-are-the-readily-available-on-the-fly-data-transforms">
<h1>What are the readily available on-the-fly data transforms?<a class="headerlink" href="#what-are-the-readily-available-on-the-fly-data-transforms" title="Permalink to this heading">¶</a></h1>
<p>It’s your lucky day! We already embedded several transforms that can be used easily.</p>
<p>Note: all the details about every flag and options for each transform can be found in the <a class="reference external" href="#train">train</a> section.</p>
<section id="general-purpose">
<h2>General purpose<a class="headerlink" href="#general-purpose" title="Permalink to this heading">¶</a></h2>
<section id="filter-examples-by-length">
<h3>Filter examples by length<a class="headerlink" href="#filter-examples-by-length" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">filtertoolong</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.misc.FilterTooLongTransform</span></code></p>
<p>The following options can be added to the configuration :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src_seq_length</span></code>: maximum source sequence length;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tgt_seq_length</span></code>: maximum target sequence length.</p></li>
</ul>
</section>
<section id="add-custom-prefix-to-examples">
<h3>Add custom prefix to examples<a class="headerlink" href="#add-custom-prefix-to-examples" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">prefix</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.misc.PrefixTransform</span></code></p>
<p>For each dataset that the <code class="docutils literal notranslate"><span class="pre">prefix</span></code> transform is applied to, you can set the additional <code class="docutils literal notranslate"><span class="pre">src_prefix</span></code> and <code class="docutils literal notranslate"><span class="pre">tgt_prefix</span></code> parameters in its data configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">data</span><span class="p">:</span>
<span class="w">    </span><span class="nt">corpus_1</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path_src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/src-train1.txt</span>
<span class="w">        </span><span class="nt">path_tgt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/tgt-train1.txt</span>
<span class="w">        </span><span class="nt">transforms</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">prefix</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">        </span><span class="nt">src_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__some_src_prefix__</span>
<span class="w">        </span><span class="nt">tgt_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__some_tgt_prefix__</span>
</pre></div>
</div>
<p>At inference if you want to use the target prefix feature to prefix your target segment with a unique prefix (as opposed to a target prefix coming from a line-by-line file)
you need to set your yaml file as follow (example given with a target language as in the NLLB-200 case):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">tgt_prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;spa_Latn&quot;</span><span class="w"> </span>
<span class="nt">tgt_file_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="add-custom-suffix-to-examples">
<h3>Add custom suffix to examples<a class="headerlink" href="#add-custom-suffix-to-examples" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">suffix</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.misc.SuffixTransform</span></code></p>
<p>For each dataset that the <code class="docutils literal notranslate"><span class="pre">suffix</span></code> transform is applied to, you can set the additional <code class="docutils literal notranslate"><span class="pre">src_suffix</span></code> and <code class="docutils literal notranslate"><span class="pre">tgt_suffix</span></code> parameters in its data configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">data</span><span class="p">:</span>
<span class="w">    </span><span class="nt">corpus_1</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path_src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/src-train1.txt</span>
<span class="w">        </span><span class="nt">path_tgt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/tgt-train1.txt</span>
<span class="w">        </span><span class="nt">transforms</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">suffix</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">        </span><span class="nt">src_suffix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__some_src_suffix__</span>
<span class="w">        </span><span class="nt">tgt_suffix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__some_tgt_suffix__</span>
</pre></div>
</div>
</section>
<section id="convert-examples-to-uppercase">
<h3>Convert examples to uppercase<a class="headerlink" href="#convert-examples-to-uppercase" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">uppercase</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.uppercase.UpperCaseTransform</span></code></p>
<p>Converts source and target (if present) examples to uppercase so the model can learn better to translate
sentences in all caps. This transform normalizes the examples so the uppercased strings are stripped from
any diacritics and accents. Usually this is desirable for most languages, although there are few exceptions.</p>
<p>The following option can be added to the main configuration (same ratio for all dataset with this transform):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">upper_corpus_ratio</span></code>: ratio of the corpus that will be transformed to uppercase (default: 0.01);</p></li>
</ul>
</section>
<section id="normalize-punctuation">
<h3>Normalize punctuation<a class="headerlink" href="#normalize-punctuation" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">normalize</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.normalize.NormalizeTransform</span></code></p>
<p>Normalizes source and target (if present) examples using the same rules as Moses punctuation normalizer.</p>
<p>The following options can be added to the configuration of each dataset:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src_lang</span></code>: en, de, cz/cs, fr (default=’’)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tgt_lang</span></code>: en, de, cz/cs, fr (default=’’)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">penn</span></code>: Penn substitution (default=True)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">norm_quote_commas</span></code>: Normalize quotations and commas (default=True)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">norm_numbers</span></code>: Normalize numbers (default=True)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pre_replace_unicode_punct</span></code>: Replace unicode punct (default=False)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">post_remove_control_chars</span></code>: Remove control chars (default=False)</p></li>
</ul>
</section>
<section id="clean-dataset">
<h3>Clean dataset<a class="headerlink" href="#clean-dataset" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">clean</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.clean.CleanTransform</span></code></p>
<p>Cleans source and target (if present) examples using a set of rules.</p>
<p>The following options can be added to the configuration of each dataset:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src_eq_tgt</span></code>: Remove example when source=target (default=True)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">same_char</span></code>: Remove example if the same char is repeated 4 times (default=True)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">same_word</span></code>: Remove example if the same word is repeated 3 times (default=True)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">script_ok</span></code>: Remove example which contains chars that do not belong to these scripts (default=[’Latin’, ‘Common’])</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">script_nok</span></code>: Remove example which contains chars that belong to these scripts  (default=[])</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src_tgt_ratio</span></code>: Remove example for which src/tgt ration is &lt;1/ratio or &gt;ratio (default=2)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avg_tok_min</span></code>: Remove example for which the average token length is &lt; X (default=3)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avg_tok_max</span></code>: Remove example for which the average token length is &gt; X (default=20)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lang_id</span></code>: Remove example for which detected language is not in [] (default=[’en’, ‘fr’])</p></li>
</ul>
</section>
<section id="context-doc-aware-transform">
<h3>Context / Doc aware transform<a class="headerlink" href="#context-doc-aware-transform" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">docify</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.docify.DocifyTransform</span></code></p>
<p>Concatenates several segments into one, separated with a delimiter.</p>
<p>Pre-requisite:</p>
<p>Dataset must be “Docs” separated by an empty line which will make clear a story ends at this empty line.</p>
<p>The following options can be added to the main configuration (same options for all dataset with this transform):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">doc_length</span></code>: max token to be concatenated (default=200)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_context</span></code>: number of delimiter (default=1 , ie 2 segments concatenated)</p></li>
</ul>
<p>When working with several workers, this require some precaution in order to make sure “doc” are read linearly.</p>
<p><code class="docutils literal notranslate"><span class="pre">max_context</span> <span class="pre">+</span> <span class="pre">1</span></code> needs to be a multiple of <code class="docutils literal notranslate"><span class="pre">stride</span></code> = <code class="docutils literal notranslate"><span class="pre">Number</span> <span class="pre">of</span> <span class="pre">gpu</span> <span class="pre">x</span> <span class="pre">num_workers</span></code></p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">max_context=1</span></code> and 1 GPU, then num_workers must be 2 or 4.</p>
</section>
<section id="augment-source-segments-with-fuzzy-matches-for-neural-fuzzy-repair">
<h3>Augment source segments with fuzzy matches for Neural Fuzzy Repair<a class="headerlink" href="#augment-source-segments-with-fuzzy-matches-for-neural-fuzzy-repair" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">fuzzymatch</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.fuzzymatch.FuzzyMatchTransform</span></code></p>
<p>Augments source segments with fuzzy matches for Neural Fuzzy Repair, as described in <a class="reference external" href="https://aclanthology.org/P19-1175">Neural Fuzzy Repair: Integrating Fuzzy Matches into Neural Machine Translation</a>. Currently, the transform augments source segments with only a single fuzzy match.
The Translation Memory (TM) format should be a flat text file, with each line containing the source and the target segment separated by a delimiter. As fuzzy matching during training is computational intensive, we offer some advice to achieve good performance and minimize overhead:</p>
<ul class="simple">
<li><p>Depending on your system’s specs, you may have to experiment with the options <code class="docutils literal notranslate"><span class="pre">bucket_size</span></code>, <code class="docutils literal notranslate"><span class="pre">bucket_size_init</span></code>, and <code class="docutils literal notranslate"><span class="pre">bucket_size_increment</span></code>;</p></li>
<li><p>You should increase the <code class="docutils literal notranslate"><span class="pre">num_workers</span></code> and <code class="docutils literal notranslate"><span class="pre">prefetch_factor</span></code> so your GPU does not have to wait for the batches to be augmented with fuzzy matches;</p></li>
<li><p>Try to use a sensible Translation Memory size. 200k-250k translation units should be enough for yielding a sufficient number of matches;</p></li>
<li><p>Although the transform performs some basic filtering both in the TM and in the corpus for very short or very long segments, some examples may still be long enough, so you should increase a bit the <code class="docutils literal notranslate"><span class="pre">src_seq_length</span></code>;</p></li>
<li><p>Currently, when using <code class="docutils literal notranslate"><span class="pre">n_sample</span></code>, examples are always processed one by one and not in batches.</p></li>
</ul>
<p>The following options can be added to the main configuration (valid for all datasets using this transform):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tm_path</span></code>: The path to the Translation Memory text file;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fuzzy_corpus_ratio</span></code>: Ratio of corpus to augment with fuzzy matches (default: 0.1);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fuzzy_threshold</span></code>: The fuzzy matching threshold (default: 70);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tm_delimiter</span></code>: The delimiter used in the flat text TM (default: “\t”);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fuzzy_token</span></code>: The fuzzy token to be added with the matches (default: “｟fuzzy｠”);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fuzzymatch_min_length</span></code>: Min length for TM entries and examples to match (default: 4);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fuzzymatch_max_length</span></code>: Max length for TM entries and examples to match (default: 70).</p></li>
</ul>
</section>
<section id="augment-source-and-target-segments-with-inline-tags">
<h3>Augment source and target segments with inline tags<a class="headerlink" href="#augment-source-and-target-segments-with-inline-tags" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">inlinetags</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.inlinetags.InlineTagsTransform</span></code></p>
<p>Augments source and target segments with inline tags (placeholders). The transform adds 2 kind of tags, paired tags (an opening and a closing tag) and isolated (standalone) tags, and requires a tab-delimited dictionary text file with source and target terms and phrases. A dictionary with 20-30k entries is recommended. User-defined tags must include the number placeholder #, e.g. “｟user_start_tag_#｠”.</p>
<p>The following options can be added to the main configuration (valid for all datasets using this transform):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tags_dictionary_path</span></code>: The path to the dictionary text file;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tags_corpus_ratio</span></code>: Ratio of corpus to augment with inline tags (default: 0.1);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_tags</span></code>: Maximum number of tags that can be added to a single sentence. (default: 12);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">paired_stag</span></code>: The format of an opening paired inline tag. Must include the character # (default: “｟ph_#_beg｠”);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">paired_etag</span></code>: The format of a closing paired inline tag. Must include the character # (default: “｟ph_#_end｠”);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">isolated_tag</span></code>: The format of an isolated inline tag. Must include the character # (default: “｟ph_#_std｠”);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src_delimiter</span></code>: Any special token used for augmented src sentences (default: “｟fuzzy｠”);</p></li>
</ul>
</section>
<section id="make-the-model-learn-to-use-terminology">
<h3>Make the model learn to use terminology<a class="headerlink" href="#make-the-model-learn-to-use-terminology" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">terminology</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.terminology.TerminologyTransform</span></code></p>
<p>Augments source segments with terms so the model can learn to use user-provided terms at inference. It requires a dictionary with source and target terms, delimited with a tab. The transform uses Spacy’s lemmatization facilities in order to a) solve the word inflection problem when searching for terms in any form, and b) make the model inflect correctly most target terms at inference. The lemmatization is applied at the dictionary entries and also at the source and target examples, and the term searches during training are performed on the lemmatized examples.
The format of a processed segment augmented with terms is as follows:
<code class="docutils literal notranslate"><span class="pre">This</span> <span class="pre">is</span> <span class="pre">an</span> <span class="pre">｟src_term_start｠</span> <span class="pre">augmented</span> <span class="pre">｟tgt_term_start｠</span> <span class="pre">target_lemma_for_augmented</span> <span class="pre">｟tgt_term_end｠</span> <span class="pre">example.</span></code>
The following options can be added to the main configuration (valid for all datasets using this transform):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">termbase_path</span></code>: The path to the dictionary text file;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src_spacy_language_model</span></code>: Name of the spacy language model for the source corpus;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tgt_spacy_language_model</span></code>: Name of the spacy language model for the target corpus;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">term_corpus_ratio</span></code>: Ratio of corpus to augment with terms # (default: 0.3);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">term_example_ratio</span></code>: Max terms allowed in an example # (default: 0.2);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src_term_stoken</span></code>: The source term start token # (default: “｟src_term_start｠”);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tgt_term_stoken</span></code>: The target term start token # (default: “｟tgt_term_start｠”);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tgt_term_etoken</span></code>: The target term end token # (default: “｟tgt_term_end｠”);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">term_source_delimiter</span></code>: Any special token used for augmented src sentences. The default is the fuzzy token used in the FuzzyMatch transform # (default: “｟fuzzy｠”);</p></li>
</ul>
</section>
</section>
<section id="tokenization">
<h2>Tokenization<a class="headerlink" href="#tokenization" title="Permalink to this heading">¶</a></h2>
<p>Common options for the tokenization transforms are the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src_subword_model</span></code>: path of source side (or both if shared) subword model;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tgt_subword_model</span></code>: path of target side subword model;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src_subword_nbest</span></code>: number of candidates for subword regularization (sentencepiece), source side;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tgt_subword_nbest</span></code>: number of candidates for subword regularization (sentencepiece), target_side;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src_subword_alpha</span></code>: smoothing parameter for sentencepiece regularization / dropout probability for BPE, source side;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tgt_subword_alpha</span></code>: smoothing parameter for sentencepiece regularization / dropout probability for BPE, target side.</p></li>
</ul>
<section id="opennmt-tokenizer">
<h3><a class="reference external" href="https://github.com/opennmt/Tokenizer">OpenNMT Tokenizer</a><a class="headerlink" href="#opennmt-tokenizer" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">onmt_tokenize</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.tokenize.ONMTTokenizerTransform</span></code></p>
<p>Additional options are available:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src_subword_type</span></code>: type of subword model for source side (from <code class="docutils literal notranslate"><span class="pre">[&quot;none&quot;,</span> <span class="pre">&quot;sentencepiece&quot;,</span> <span class="pre">&quot;bpe&quot;]</span></code>);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tgt_subword_type</span></code>: type of subword model for target side (from <code class="docutils literal notranslate"><span class="pre">[&quot;none&quot;,</span> <span class="pre">&quot;sentencepiece&quot;,</span> <span class="pre">&quot;bpe&quot;]</span></code>);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src_onmttok_kwargs</span></code>: additional kwargs for pyonmttok Tokenizer class, source side;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tgt_onmttok_kwargs</span></code>: additional kwargs for pyonmttok Tokenizer class, target side.</p></li>
</ul>
</section>
<section id="sentencepiece">
<h3><a class="reference external" href="https://github.com/google/sentencepiece">SentencePiece</a><a class="headerlink" href="#sentencepiece" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">sentencepiece</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.tokenize.SentencePieceTransform</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">src_subword_model</span></code> and <code class="docutils literal notranslate"><span class="pre">tgt_subword_model</span></code> should be valid sentencepiece models.</p>
</section>
<section id="bpe-subword-nmt">
<h3><a class="reference external" href="https://github.com/rsennrich/subword-nmt">BPE subword-nmt</a><a class="headerlink" href="#bpe-subword-nmt" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">bpe</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.tokenize.BPETransform</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">src_subword_model</span></code> and <code class="docutils literal notranslate"><span class="pre">tgt_subword_model</span></code> should be valid BPE models.</p>
</section>
</section>
<section id="bart-style-noise">
<h2>BART-style noise<a class="headerlink" href="#bart-style-noise" title="Permalink to this heading">¶</a></h2>
<p>BART-style noise is composed of several parts, as described in <a class="reference external" href="https://arxiv.org/abs/1910.13461">BART: Denoising Sequence-to-Sequence Pre-training for Natural Language Generation, Translation, and Comprehension</a>.</p>
<p>These different types of noise can be controlled with the following options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">permute_sent_ratio</span></code>: proportion of sentences to permute (default boundaries are “.”, “?” and “!”);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rotate_ratio</span></code>: proportion of inputs to permute;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">insert_ratio</span></code>: proportion of additional random tokens to insert;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">random_ratio</span></code>: proportion of tokens to replace with random;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mask_ratio</span></code>: proportion of words/subwords to mask;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mask_length</span></code>: length of masking window (from <code class="docutils literal notranslate"><span class="pre">[&quot;subword&quot;,</span> <span class="pre">&quot;word&quot;,</span> <span class="pre">&quot;span-poisson&quot;]</span></code>);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">poisson_lambda</span></code>: $\lambda$ value for Poisson distribution to sample span length (in the case of <code class="docutils literal notranslate"><span class="pre">mask_length</span></code> set to <code class="docutils literal notranslate"><span class="pre">span-poisson</span></code>);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">replace_length</span></code>: when masking N tokens, replace with 0, 1, “ “or N tokens. (set to -1 for N).</p></li>
</ul>
</section>
<section id="switchout-and-sampling">
<h2>SwitchOut and sampling<a class="headerlink" href="#switchout-and-sampling" title="Permalink to this heading">¶</a></h2>
<section id="switchout">
<h3><a class="reference external" href="https://arxiv.org/abs/1808.07512">SwitchOut</a><a class="headerlink" href="#switchout" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">switchout</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.sampling.SwitchOutTransform</span></code></p>
<p>Options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">switchout_temperature</span></code>: sampling temperature for SwitchOut.</p></li>
</ul>
</section>
<section id="drop-some-tokens">
<h3>Drop some tokens<a class="headerlink" href="#drop-some-tokens" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">tokendrop</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.sampling.TokenDropTransform</span></code></p>
<p>Options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tokendrop_temperature</span></code>: sampling temperature for token deletion.</p></li>
</ul>
</section>
<section id="mask-some-tokens">
<h3>Mask some tokens<a class="headerlink" href="#mask-some-tokens" title="Permalink to this heading">¶</a></h3>
<p>Transform name: <code class="docutils literal notranslate"><span class="pre">tokenmask</span></code></p>
<p>Class: <code class="docutils literal notranslate"><span class="pre">onmt.transforms.sampling.TokenMaskTransform</span></code></p>
<p>Options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tokenmask_temperature</span></code>: sampling temperature for token masking.</p></li>
</ul>
</section>
</section>
</section>
<section id="how-can-i-create-custom-on-the-fly-data-transforms">
<h1>How can I create custom on-the-fly data transforms?<a class="headerlink" href="#how-can-i-create-custom-on-the-fly-data-transforms" title="Permalink to this heading">¶</a></h1>
<p>The code is easily extendable with custom transforms inheriting from the <code class="docutils literal notranslate"><span class="pre">Transform</span></code> base class.</p>
<p>You can for instance have a look at the <code class="docutils literal notranslate"><span class="pre">FilterTooLongTransform</span></code> class as a template:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@register_transform</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;filtertoolong&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">FilterTooLongTransform</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter out sentence that are too long.&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_options</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Avalilable options relate to this Transform.&quot;&quot;&quot;</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;Transform/Filter&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;--src_seq_length&quot;</span><span class="p">,</span> <span class="s2">&quot;-src_seq_length&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum source sequence length.&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;--tgt_seq_length&quot;</span><span class="p">,</span> <span class="s2">&quot;-tgt_seq_length&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum target sequence length.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_opts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_seq_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">src_seq_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_seq_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">tgt_seq_length</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return None if too long else return as is.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_seq_length</span> <span class="ow">or</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;tgt&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_seq_length</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">FilterTooLongStats</span><span class="p">())</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">example</span>

    <span class="k">def</span> <span class="nf">_repr_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return str represent key arguments for class.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39;src_seq_length&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_seq_length</span><span class="p">,</span>
            <span class="s1">&#39;tgt_seq_length&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_seq_length</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>Methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">add_options</span></code> allows to add custom options that would be necessary for the transform configuration;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_parse_opts</span></code> allows to parse options introduced in <code class="docutils literal notranslate"><span class="pre">add_options</span></code> when initialize;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">apply</span></code> is where the transform happens;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_repr_args</span></code> is for clean logging purposes.</p></li>
</ul>
<p>As you can see, there is the <code class="docutils literal notranslate"><span class="pre">&#64;register_transform</span></code> wrapper before the class definition. This will allow for the class to be automatically detected (if put in the proper <code class="docutils literal notranslate"><span class="pre">transforms</span></code> folder) and usable in your training configurations through its <code class="docutils literal notranslate"><span class="pre">name</span></code> argument.</p>
<p>You could also collect statistics for your custom transform by creating a class inheriting <code class="docutils literal notranslate"><span class="pre">ObservableStats</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FilterTooLongStats</span><span class="p">(</span><span class="n">ObservableStats</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Runing statistics for FilterTooLongTransform.&quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;filtered&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;FilterTooLongStats&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">filtered</span>
</pre></div>
</div>
<p>NOTE:</p>
<ul class="simple">
<li><p>Add elements to keep track in the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> and also <code class="docutils literal notranslate"><span class="pre">__slot__</span></code> to make it lightweight;</p></li>
<li><p>Supply update logic in <code class="docutils literal notranslate"><span class="pre">update</span></code> method;</p></li>
<li><p>(Optional) override <code class="docutils literal notranslate"><span class="pre">__str__</span></code> to change default log message format;</p></li>
<li><p>Instantiate and passing the statistic object in the <code class="docutils literal notranslate"><span class="pre">apply</span></code> method of the corresponding transform class;</p></li>
<li><p>statistics will be gathered per corpus per worker, but only first worker will report for its shard by default.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">example</span></code> argument of <code class="docutils literal notranslate"><span class="pre">apply</span></code> is a <code class="docutils literal notranslate"><span class="pre">dict</span></code> of the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
	<span class="s2">&quot;src&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">source</span> <span class="n">string</span><span class="o">&gt;</span><span class="p">,</span>
	<span class="s2">&quot;tgt&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">target</span> <span class="n">string</span><span class="o">&gt;</span><span class="p">,</span>
	<span class="s2">&quot;align&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">alignment</span> <span class="n">pharaoh</span> <span class="n">string</span><span class="o">&gt;</span> <span class="c1"># optional</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is defined in <code class="docutils literal notranslate"><span class="pre">onmt.inputters.corpus.ParallelCorpus.load</span></code>. This class is not easily extendable for now but it can be considered for future developments. For instance, we could create some <code class="docutils literal notranslate"><span class="pre">CustomParallelCorpus</span></code> class that would handle other kind of inputs.</p>
</section>
<section id="how-to-use-lora-and-8bit-loading-to-finetune-a-big-model">
<h1>How to use LoRa and 8bit loading to finetune a big model ?<a class="headerlink" href="#how-to-use-lora-and-8bit-loading-to-finetune-a-big-model" title="Permalink to this heading">¶</a></h1>
<p>Cf paper: <a class="reference external" href="https://arxiv.org/abs/2106.09685">LoRa</a></p>
<p>LoRa is a mechanism that helps to finetune bigger model on a single GPU card by limiting the anmount of VRAM needed.
The principle is to make only a few layers trainable (hence reducing the amount of required memory especially for the Adam optimizer)</p>
<p>You need to train_from a model (for instance NLLB-200 3.3B) and use the following options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lora_layers:</span> <span class="pre">['linear_values',</span> <span class="pre">'linear_query']</span></code> these are the two layers of the Self-Attention module the paper recommend to make trainable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lora_rank:</span> <span class="pre">2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lora_dropout:</span> <span class="pre">0.1</span></code> or any value you can test</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lora_alpha:</span> <span class="pre">1</span></code> or any value you can test</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lora_embedding:</span> <span class="pre">true</span></code> makes Embeddings LoRa compatible, hence trainable in the case you use <code class="docutils literal notranslate"><span class="pre">update_vocab:</span> <span class="pre">true</span></code> or if you want to finetune Embeddings as well.</p></li>
</ul>
<p>Bitsandbytes enables quantization of Linear layers. For more information: https://github.com/TimDettmers/bitsandbytes
Also you can read the blog post here: https://huggingface.co/blog/hf-bitsandbytes-integration</p>
<p>You need to add the following option:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">quant_layers:</span> <span class="pre">['w_1',</span> <span class="pre">'w_2',</span> <span class="pre">'linear_values',</span> <span class="pre">'linear_query']</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">quant_type:</span> <span class="pre">['bnb_NF4']</span></code></p></li>
</ul>
<p>You can for instane quantize the layers of the PositionWise Feed-Forward from the Encoder/Decoder and the key/query/values/final from the Multi-head attention.
Choices for quantization are [”bnb_8bit”, “bnb_FP4”, “bnb_NF4”]</p>
</section>
<section id="how-to-use-gradient-checkpointing-when-dealing-with-a-big-model">
<h1>How to use gradient checkpointing when dealing with a big model ?<a class="headerlink" href="#how-to-use-gradient-checkpointing-when-dealing-with-a-big-model" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">use_ckpting:</span> <span class="pre">[&quot;ffn&quot;,</span> <span class="pre">&quot;mha&quot;,</span> <span class="pre">&quot;lora&quot;]</span></code></p></li>
</ul>
<p>Be carefull, the module that you use checkpointing needs to have gradients.</p>
</section>
<section id="can-i-get-word-alignments-while-translating">
<h1>Can I get word alignments while translating?<a class="headerlink" href="#can-i-get-word-alignments-while-translating" title="Permalink to this heading">¶</a></h1>
<section id="raw-alignments-from-averaging-transformer-attention-heads">
<h2>Raw alignments from averaging Transformer attention heads<a class="headerlink" href="#raw-alignments-from-averaging-transformer-attention-heads" title="Permalink to this heading">¶</a></h2>
<p>Currently, we support producing word alignment while translating for Transformer based models. Using <code class="docutils literal notranslate"><span class="pre">-report_align</span></code> when calling <code class="docutils literal notranslate"><span class="pre">translate.py</span></code> will output the inferred alignments in Pharaoh format. Those alignments are computed from an argmax on the average of the attention heads of the <em>second to last</em> decoder layer. The resulting alignment src-tgt (Pharaoh) will be pasted to the translation sentence, separated by <code class="docutils literal notranslate"><span class="pre">|||</span></code>.
Note: The <em>second to last</em> default behaviour was empirically determined. It is not the same as the paper (they take the <em>penultimate</em> layer), probably because of slight differences in the architecture.</p>
<ul class="simple">
<li><p>alignments use the standard “Pharaoh format”, where a pair <code class="docutils literal notranslate"><span class="pre">i-j</span></code> indicates the i<sub>th</sub> word of source language is aligned to j<sub>th</sub> word of target language.</p></li>
<li><p>Example: {’src’: ‘das stimmt nicht !’; ‘output’: ‘that is not true ! ||| 0-0 0-1 1-2 2-3 1-4 1-5 3-6’}</p></li>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">-tgt</span></code> and <code class="docutils literal notranslate"><span class="pre">-gold_align</span></code> options when calling <code class="docutils literal notranslate"><span class="pre">translate.py</span></code>, we output alignments between the source and the gold target rather than the inferred target, assuming we’re doing evaluation.</p></li>
<li><p>To convert subword alignments to word alignments, or symetrize bidirectional alignments, please refer to the <a class="reference external" href="https://github.com/lilt/alignment-scripts">lilt scripts</a>.</p></li>
</ul>
</section>
<section id="supervised-learning-on-a-specific-head">
<h2>Supervised learning on a specific head<a class="headerlink" href="#supervised-learning-on-a-specific-head" title="Permalink to this heading">¶</a></h2>
<p>The quality of output alignments can be further improved by providing reference alignments while training. This will invoke multi-task learning on translation and alignment. This is an implementation based on the paper <a class="reference external" href="https://arxiv.org/abs/1909.02074">Jointly Learning to Align and Translate with Transformer Models</a>.</p>
<p>The data need to be preprocessed with the reference alignments in order to learn the supervised task.
The reference alignment file(s) can for instance be generated by <a class="reference external" href="https://github.com/moses-smt/mgiza/">GIZA++</a> or <a class="reference external" href="https://github.com/clab/fast_align">fast_align</a>.</p>
<p>In order to learn the supervised task, you can set for each dataset the path of its alignment file in the YAML configuration file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">&lt;your_config&gt;.yaml</span>

<span class="nn">...</span>

<span class="c1"># Corpus opts:</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">    </span><span class="nt">corpus_1</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path_src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/src-train1.txt</span>
<span class="w">        </span><span class="nt">path_tgt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/tgt-train1.txt</span>
<span class="w">        </span><span class="c1"># src - tgt alignments in pharaoh format</span>
<span class="w">        </span><span class="nt">path_align</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/src-tgt.align</span>
<span class="w">        </span><span class="nt">transforms</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">        </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">valid</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path_src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/src-val.txt</span>
<span class="w">        </span><span class="nt">path_tgt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">toy-ende/tgt-val.txt</span>
<span class="w">        </span><span class="nt">transforms</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>

<span class="nn">...</span>
</pre></div>
</div>
<p><strong>Notes</strong>:</p>
<ul class="simple">
<li><p>Most of the transforms are for now incompatible with the joint alignment learning pipeline, because most of them make modifications at the token level, hence alignments would be made invalid.</p></li>
<li><p>There should be no blank lines in the alignment files provided.</p></li>
</ul>
<p>Training options to learn such alignments are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-lambda_align</span></code>: set the value &gt; 0.0 to enable joint align training, the paper suggests 0.05;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-alignment_layer</span></code>: indicate the index of the decoder layer;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-alignment_heads</span></code>:  number of alignment heads for the alignment task - should be set to 1 for the supervised task, and preferably kept to default (or same as <code class="docutils literal notranslate"><span class="pre">num_heads</span></code>) for the average task;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-full_context_alignment</span></code>: do full context decoder pass (no future mask) when computing alignments. This will slow down the training (~12% in terms of tok/s) but will be beneficial to generate better alignment.</p></li>
</ul>
</section>
</section>
<section id="how-can-i-update-a-checkpoint-s-vocabulary">
<h1>How can I update a checkpoint’s vocabulary?<a class="headerlink" href="#how-can-i-update-a-checkpoint-s-vocabulary" title="Permalink to this heading">¶</a></h1>
<p>New vocabulary can be used to continue training from a checkpoint. Existing vocabulary embeddings will be mapped to the new vocabulary, and new vocabulary tokens will be initialized as usual.</p>
<p>Run <code class="docutils literal notranslate"><span class="pre">onmt_build_vocab</span></code> as usual with the new dataset. New vocabulary files will be created.</p>
<p>Training options to perform vocabulary update are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-update_vocab</span></code>: set this option</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-reset_optim</span></code>: set the value to “states”</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-train_from</span></code>: checkpoint path</p></li>
</ul>
</section>
<section id="how-can-i-use-source-word-features">
<h1>How can I use source word features?<a class="headerlink" href="#how-can-i-use-source-word-features" title="Permalink to this heading">¶</a></h1>
<p>Additional word-level information can be incorporated into the model by defining word features in the source sentence.</p>
<p>Word features must be appended to the actual textual data by using the special character ￨ as a feature separator. For instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>however￨C ￭,￨N according￨L to￨L the￨L logs￨L ￭,￨N she￨L is￨L hard-working￨L ￭.￨N
</pre></div>
</div>
<p>Prior tokenization is not necessary, features will be inferred by using the <code class="docutils literal notranslate"><span class="pre">FeatInferTransform</span></code> transform if tokenization has been applied. For instace:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SRC: however,￨C according￨L to￨L the￨L logs,￨L she￨L is￨L hard-working.￨L
TOKENIZED SRC: however ￭, according to the logs ￭, she is hard-working ￭.
RESULT: however￨C ￭,￨C according￨L to￨L the￨L logs￨L ￭,￨L she￨L is￨L hard￨L ￭-￭￨L working￨L ￭.￨L
</pre></div>
</div>
<p><strong>Options</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-n_src_feats</span></code>: the expected number of source features per token.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-src_feats_defaults</span></code> (optional): provides default values for features. This can be really useful when mixing task specific data (with features) with general data which has not been annotated.</p></li>
</ul>
<p>For the Transformer architecture make sure the following options are appropriately set:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src_word_vec_size</span></code> and <code class="docutils literal notranslate"><span class="pre">tgt_word_vec_size</span></code> or <code class="docutils literal notranslate"><span class="pre">word_vec_size</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">feat_merge</span></code>: how to handle features vecs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">feat_vec_size</span></code> or maybe <code class="docutils literal notranslate"><span class="pre">feat_vec_exponent</span></code></p></li>
</ul>
<p><strong>Notes</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FeatInferTransform</span></code> transform is required in order to ensure the functionality.</p></li>
<li><p>Not possible to do shared embeddings (at least with <code class="docutils literal notranslate"><span class="pre">feat_merge:</span> <span class="pre">concat</span></code> method)</p></li>
</ul>
<p>Sample config file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">:</span>
    <span class="n">dummy</span><span class="p">:</span>
        <span class="n">path_src</span><span class="p">:</span> <span class="n">data</span><span class="o">/</span><span class="n">train</span><span class="o">/</span><span class="n">data</span><span class="o">.</span><span class="n">src</span>
        <span class="n">path_tgt</span><span class="p">:</span> <span class="n">data</span><span class="o">/</span><span class="n">train</span><span class="o">/</span><span class="n">data</span><span class="o">.</span><span class="n">tgt</span>
        <span class="n">transforms</span><span class="p">:</span> <span class="p">[</span><span class="n">onmt_tokenize</span><span class="p">,</span> <span class="n">inferfeats</span><span class="p">,</span> <span class="n">filtertoolong</span><span class="p">]</span>
        <span class="n">weight</span><span class="p">:</span> <span class="mi">1</span>
    <span class="n">valid</span><span class="p">:</span>
        <span class="n">path_src</span><span class="p">:</span> <span class="n">data</span><span class="o">/</span><span class="n">valid</span><span class="o">/</span><span class="n">data</span><span class="o">.</span><span class="n">src</span>
        <span class="n">path_tgt</span><span class="p">:</span> <span class="n">data</span><span class="o">/</span><span class="n">valid</span><span class="o">/</span><span class="n">data</span><span class="o">.</span><span class="n">tgt</span>
        <span class="n">transforms</span><span class="p">:</span> <span class="p">[</span><span class="n">onmt_tokenize</span><span class="p">,</span> <span class="n">inferfeats</span><span class="p">]</span>

<span class="c1"># Transform options</span>
<span class="n">reversible_tokenization</span><span class="p">:</span> <span class="s2">&quot;joiner&quot;</span>

<span class="c1"># Vocab opts</span>
<span class="n">src_vocab</span><span class="p">:</span> <span class="n">exp</span><span class="o">/</span><span class="n">data</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">src</span>
<span class="n">tgt_vocab</span><span class="p">:</span> <span class="n">exp</span><span class="o">/</span><span class="n">data</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">tgt</span>

<span class="c1"># Features options</span>
<span class="n">n_src_feats</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">src_feats_defaults</span><span class="p">:</span> <span class="s2">&quot;0￨1&quot;</span>
<span class="n">feat_merge</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span>
</pre></div>
</div>
<p>To allow source features in the server add the following parameters in the server’s config file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;n_src_feats&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;src_feats_defaults&quot;</span><span class="p">:</span> <span class="s2">&quot;0￨1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reversible_tokenization&quot;</span><span class="p">:</span> <span class="s2">&quot;joiner&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="how-can-i-set-up-a-translation-server">
<h1>How can I set up a translation server ?<a class="headerlink" href="#how-can-i-set-up-a-translation-server" title="Permalink to this heading">¶</a></h1>
<p>A REST server was implemented to serve OpenNMT-py models. A discussion is opened on the OpenNMT forum: <a class="reference external" href="https://forum.opennmt.net/t/simple-opennmt-py-rest-server/1392">discussion link</a>.</p>
<section id="i-how-it-works">
<h2>I. How it works?<a class="headerlink" href="#i-how-it-works" title="Permalink to this heading">¶</a></h2>
<p>The idea behind the translation server is to make a entry point for translation with multiple models. The server will receive natural text input, tokenize it, translate it following the decoding parameters, detokenize the result and return natural text output.</p>
<p>A server configuration file (<code class="docutils literal notranslate"><span class="pre">./available_models/conf.json</span></code>) is required. It contains the path of the model checkpoint, the path of tokenizer’s data along with other inference parameters.</p>
<section id="configuration">
<h3>Configuration:<a class="headerlink" href="#configuration" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">models_root</span></code>: (opt) folder containing model checkpoints, [default: <code class="docutils literal notranslate"><span class="pre">./available_models</span></code>]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">models</span></code>: list of objects such as :</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">id</span></code>: (opt) manually assign an id (int), [default: value from counter]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code>: (opt) assing a name (str)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">model</span></code>: (required) path to checkpoint file i.e. <code class="docutils literal notranslate"><span class="pre">*.pt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timeout</span></code>: (opt) interval (seconds) before unloading, reset at each translation using the model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load</span></code>: (opt) whether to load the model at start [default: False]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on_timeout</span></code>: (opt) what to do on timeout: <code class="docutils literal notranslate"><span class="pre">unload</span></code> removes everything; <code class="docutils literal notranslate"><span class="pre">to_cpu</span></code> transfer the model to RAM (from GPU memory) this is faster to reload but takes RAM.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">opt</span></code>: (opt) dict of translation options (see method <code class="docutils literal notranslate"><span class="pre">translate_opts</span></code> in <code class="docutils literal notranslate"><span class="pre">./opts.py</span></code>)</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">report_align</span></code>: (bool) return word alignment in pharaoh (’src-tgt’) format for every space separated word.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">tokenizer</span></code>: (opt) set tokenizer options (if any), such as:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">type</span></code>: (str) value in <code class="docutils literal notranslate"><span class="pre">{sentencepiece,</span> <span class="pre">pyonmttok}</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">model</span></code>: (str) path to tokenizer model</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">ct2_translator_args</span></code> and <code class="docutils literal notranslate"><span class="pre">ct2_translate_batch_args</span></code>: (opt) <a class="reference external" href="https://github.com/OpenNMT/CTranslate2">CTranslate2</a> parameters to use CTranslate2 inference engine. Parameters appearing simultaneously in <code class="docutils literal notranslate"><span class="pre">opt</span></code> and <code class="docutils literal notranslate"><span class="pre">ct2_(...)_args</span></code> must be identical.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ct2_model</span></code>: (opt) CTranslate2 model path.</p></li>
</ul>
</li>
</ul>
</section>
<section id="id3">
<h3>Example<a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;models_root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./available_models&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;models&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w">   </span>
<span class="w">            </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;model&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;model_0.pt&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;timeout&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;on_timeout&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;to_cpu&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;load&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;opt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;gpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;beam_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">            </span><span class="p">},</span><span class="w">  </span>
<span class="w">            </span><span class="nt">&quot;tokenizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sentencepiece&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;model&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;wmtenfr.model&quot;</span>
<span class="w">            </span><span class="p">}</span><span class="w">   </span>
<span class="w">        </span><span class="p">},{</span><span class="w"> </span>
<span class="w">            </span><span class="nt">&quot;model&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;model_0.light.pt&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;timeout&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="nt">&quot;on_timeout&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;unload&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;model_root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;../other_models&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;opt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;batch_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;beam_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span>
<span class="w">            </span><span class="p">}</span><span class="w">   </span>
<span class="w">        </span><span class="p">}</span><span class="w">   </span>
<span class="w">    </span><span class="p">]</span><span class="w">   </span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="ii-how-to-start-the-server-without-docker">
<h2>II. How to start the server without Docker ?<a class="headerlink" href="#ii-how-to-start-the-server-without-docker" title="Permalink to this heading">¶</a></h2>
<section id="get-the-code">
<h3>0. Get the code<a class="headerlink" href="#get-the-code" title="Permalink to this heading">¶</a></h3>
<p>The translation server has been merged into onmt-py <code class="docutils literal notranslate"><span class="pre">master</span></code> branch.
Keep in line with master for last fix / improvements.</p>
</section>
<section id="install-flask">
<h3>1. Install <code class="docutils literal notranslate"><span class="pre">flask</span></code><a class="headerlink" href="#install-flask" title="Permalink to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>flask
</pre></div>
</div>
</section>
<section id="put-some-models">
<h3>2. Put some models<a class="headerlink" href="#put-some-models" title="Permalink to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>available_models/
cp<span class="w"> </span><span class="nv">$path_to_my_model</span><span class="w"> </span>available_models
</pre></div>
</div>
</section>
<section id="start-the-server">
<h3>3. Start the server<a class="headerlink" href="#start-the-server" title="Permalink to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">IP</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PORT</span><span class="o">=</span><span class="m">5000</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">URL_ROOT</span><span class="o">=</span><span class="s2">&quot;/translator&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CONFIG</span><span class="o">=</span><span class="s2">&quot;./available_models/conf.json&quot;</span>

<span class="c1"># NOTE that these parameters are optionnal</span>
<span class="c1"># here, we explicitely set to default values</span>
python<span class="w"> </span>server.py<span class="w"> </span>--ip<span class="w"> </span><span class="nv">$IP</span><span class="w"> </span>--port<span class="w"> </span><span class="nv">$PORT</span><span class="w"> </span>--url_root<span class="w"> </span><span class="nv">$URL_ROOT</span><span class="w"> </span>--config<span class="w"> </span><span class="nv">$CONFIG</span>
</pre></div>
</div>
</section>
</section>
<section id="iii-how-to-start-the-server-with-docker">
<h2>III. How to start the server with Docker ?<a class="headerlink" href="#iii-how-to-start-the-server-with-docker" title="Permalink to this heading">¶</a></h2>
<ol class="simple">
<li><p>Add the following libraries a requirement file <code class="docutils literal notranslate"><span class="pre">requirements.docker.txt</span></code>.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ConfigArgParse</span><span class="o">==</span><span class="mf">1.2.3</span>
<span class="n">Flask</span><span class="o">==</span><span class="mf">1.1.2</span>
<span class="n">Flask</span><span class="o">-</span><span class="n">Cors</span><span class="o">==</span><span class="mf">3.0.10</span>
<span class="n">pyonmttok</span><span class="o">==</span><span class="mf">1.22.1</span>
<span class="n">torchtext</span><span class="o">==</span><span class="mf">0.4.0</span>
<span class="n">waitress</span><span class="o">==</span><span class="mf">1.4.4</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Create a <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code></p></li>
</ol>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">pytorch/pytorch:1.6.0-cuda10.1-cudnn7-runtime</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="k">COPY</span><span class="w"> </span>requirements.docker.txt<span class="w"> </span>./requirements.txt
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c"># You can copy or use a docker volume, especially for the model and config data</span>
<span class="k">COPY</span><span class="w"> </span>server.py<span class="w"> </span>./
<span class="k">COPY</span><span class="w"> </span>tools<span class="w"> </span>./tools
<span class="k">COPY</span><span class="w"> </span>available_models<span class="w"> </span>./available_models
<span class="k">COPY</span><span class="w"> </span>onmt<span class="w"> </span>./onmt

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;./server.py&quot;</span><span class="p">]</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Build the image and run container</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>opennmt_server<span class="w"> </span>.
docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>-p<span class="w"> </span><span class="m">5000</span>:5000<span class="w"> </span>opennmt_server
</pre></div>
</div>
</section>
<section id="iv-how-to-use-the-api">
<h2>IV. How to use the API ?<a class="headerlink" href="#iv-how-to-use-the-api" title="Permalink to this heading">¶</a></h2>
<p>This section contains a fex examples of the API. For details on all routes, see <code class="docutils literal notranslate"><span class="pre">./bin/server.py</span></code>.</p>
<section id="set-the-hostname">
<h3>0. Set the hostname<a class="headerlink" href="#set-the-hostname" title="Permalink to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">HOST</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span>
</pre></div>
</div>
</section>
<section id="list-models">
<h3>1. List models<a class="headerlink" href="#list-models" title="Permalink to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>http://<span class="nv">$HOST</span>:<span class="nv">$PORT$URL_ROOT</span>/models
</pre></div>
</div>
<p><strong>Result (example):</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;available&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;wmt14.en-de_acc_69.22_ppl_4.33_e9.pt&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;wmt14.en-de_acc_69.22_ppl_4.33_e9.light.pt&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;loaded&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="translate">
<h3>2. Translate<a class="headerlink" href="#translate" title="Permalink to this heading">¶</a></h3>
<p>(this example involves subwords)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-i<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-d<span class="w"> </span><span class="s1">&#39;[{&quot;src&quot;: &quot;this is a test for model 0&quot;, &quot;id&quot;: 0}]&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>http://<span class="nv">$HOST</span>:<span class="nv">$PORT$URL_ROOT</span>/translate
</pre></div>
</div>
<p><strong>Result:</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;model_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;result&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;\u2581die \u2581Formen kant en \u2581( K \u00f6r ner ) \u2581des \u2581Stahl g u\u00df form .\n&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ok&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;total&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">8.510261535644531</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;translation&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">8.509992599487305</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;writing_src&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0002689361572265625</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="examples/wmt17/Translation.html" class="btn btn-neutral float-right" title="Translation WMT17 en-de" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ref.html" class="btn btn-neutral float-left" title="References" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2023, OpenNMT

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>